# HyperLogLogUltraMax: что изменилось и анализ (Этап 3 для улучшенной версии)

## Суть изменений (Этап 4)
Я сделала улучшенную версию **HyperLogLogUltraMax** по двум идеям:

1) **Исправление вычисления `rho` (самое важное)**
- Раньше `rho` считался как число ведущих нулей в 32-битном числе, начиная с 31-го бита.
- Но после сдвига `remaining = hash >> B` у числа значимыми остаются только **(32 − B)** бит, а старшие биты почти всегда нули.
- Из-за этого `rho` получался **слишком большим**, регистры быстро “раздувались”, и оценка улетала до **10^8–10^9** (явно неверно).
- Исправление: считать ведущие нули **только в диапазоне `maxBits = 32 − B`**, то есть проверять биты от `maxBits-1` до `0`.

2) **UltraMax-агрегация для повышения стабильности**
- В UltraMax хранится несколько независимых HLL (с разными seed).
- Итоговая оценка берётся как **медиана** оценок.
- Медиана меньше зависит от “неудачного” хеша и обычно даёт **меньший разброс (σ)** между потоками.

---

## Этап 3. Анализ результатов улучшенной версии

### 1) Точность (сравнение с истинным значением)
По графику сравнения видно:
- линия **оценки** идёт очень близко к **Ft0 (точному числу уникальных)**;
- ошибка не растёт “в одну сторону” постоянно — она меняет знак и остаётся небольшой по сравнению с масштабом (сотни тысяч / миллионы).

Главный вывод: после исправления `rho` оценка стала **адекватной** (больше нет взрывного роста до миллиардов).

### 2) Ошибка (абсолютная)
График `Nt − Ft0` показывает:
- ошибка колеблется вокруг 0;
- на больших t ошибка остаётся в диапазоне **десятков тысяч** при Ft0 порядка **миллиона**, то есть это **несколько процентов**, что нормально для HLL.

### 3) Стабильность (разброс между потоками)
Для улучшенной версии ожидается:
- **σ(Nt)** меньше (или по крайней мере не больше), потому что медиана по нескольким скетчам “гасит” выбросы.
- На практике это проверяется по CSV `graph3.csv` и графику “E(Nt) ± σ”.

### 4) Итоговый вывод
- Исправление `rho` устранило критическую ошибку и вернуло алгоритм в корректный режим.
- UltraMax добавляет устойчивость: итоговая оценка становится менее чувствительной к случайным колебаниям одного конкретного хеша/потока.

---

## Что прикладывается к отчёту
- `graph3.csv`: сравнение **Ft0** и **NtUltra** для одного потока.
- `graph4.csv`: статистика по нескольким потокам (**E(NtUltra)** и **σ(NtUltra)**).
